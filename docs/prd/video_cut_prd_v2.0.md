
# 产品需求文档 (PRD) - B站英语单词视频定位服务 (Bilibili Word Locator)

| 文档版本 | 修改日期 | 修改人 | 备注 |
| :--- | :--- | :--- | :--- |
| V1.0 | 2024-11-XX | Team | 初始版本（本地文件方案） |
| **V2.0** | **2024-11-30** | **Team** | **重大架构变更**：废弃本地视频存储，改为基于 Bilibili 在线视频源。引入音频临时下载与嵌入式播放器方案。实现中英混合语音识别、严格英文单词过滤、自动去重等优化。 |

## 1. 项目背景与目标

### 1.1 项目背景
用户希望利用 Bilibili（B站）上丰富的英语学习资源进行针对性学习。当用户需要查询特定单词时，希望系统能直接检索已收录的 B站视频，并在当前页面通过嵌入式播放器直接跳转到单词出现的精确时间点，而无需下载视频文件或跳转至 B站官网寻找。

### 1.2 项目目标
开发一套**基于 Bilibili 视频源的在线索引与播放服务**。
1.  **零本地存储**：不下载、不存储视频文件，仅在处理阶段临时下载音频用于分析，最大限度节省存储空间。
2.  **在线流式播放**：利用 Bilibili 官方提供的嵌入式播放器（Iframe），实现视频在自有网站的直接播放。
3.  **精准定位跳转**：通过 URL 参数或播放器 API，实现点击单词即跳转至 B站视频的对应进度条位置。

## 2. 需求范围 (Scope)

### 2.1 包含内容 (In Scope)
*   **资源获取**：输入 Bilibili 视频链接或 BVID，后端工具提取音频流（支持缓存复用）。
*   **内容分析**：ASR（语音识别）生成句子级时间轴索引，自动识别并提取英文单词。
*   **索引构建**：建立"英文单词 -> [BVID, 时间点]"的映射关系，自动过滤中文干扰项。
*   **智能去重**：合并短时间内重复出现的单词（默认60秒阈值）。
*   **嵌入式播放**：前端集成 Bilibili Iframe 播放器，并根据索引控制播放进度。

### 2.2 不包含内容 (Out of Scope)
*   **视频存储**：**严禁**长期存储任何视频或音频文件。
*   **付费内容破解**：不支持 Bilibili 大会员专属或付费视频的解析。
*   **弹幕/评论抓取**：仅关注视频内容的语音部分。

## 3. 详细功能需求 (Functional Requirements)

### 3.1 视频元数据与音频提取 (Backend Processing)
*   **输入**：包含 Bilibili 视频 ID (BVID) 的列表（如 `BV1xx...`）。
*   **处理逻辑**：
    1.  **智能下载**：调用 `you-get` 工具下载视频到临时目录（已存在则跳过）。
    2.  **音频提取**：使用 `ffmpeg` 从视频中提取音频（支持指定时间段，如16:00-20:00）。
    3.  **混合语言识别**：调用官方 `whisper` 进行 ASR，使用 **`medium`** 模型（升级自 `base`），显著提升中英混合语音的识别准确率。
    4.  **单词提取与过滤**：
        *   **正则提取**：使用正则表达式 `[a-zA-Z]+(?:-[a-zA-Z]+)*` 从混合文本中提取英文单词，解决中英粘连问题（如 "Action行动"）。
        *   **停用词过滤**：过滤掉 `is`, `the`, `and` 等常见辅助词。
        *   **严格过滤**：仅保留纯 ASCII 英文单词（允许连字符）。
    5.  **频率密度过滤（讲解单词识别）**：
        *   **目标**：过滤掉辅助性高频词，只索引真正被讲解的单词。
        *   **核心原理**：讲解单词时，老师会在短时间内反复使用该词。
        *   **算法逻辑**：
            1. 对每个单词的所有出现时间点按时间排序。
            2. 使用**滑动时间窗口**（默认120秒）遍历时间点序列。
            3. 计算每个窗口内该单词的出现次数。
            4. 如果存在至少一个窗口内出现次数 ≥ **密度阈值**（**3次**），则该单词被认为是"被讲解词"，保留索引。
            5. 否则视为辅助词或偶然出现，不予索引。
        *   **参数配置**：
            *   `time_window`: 120秒（2分钟，讲解一个单词的典型时长）
            *   `density_threshold`: **3次**（在窗口内至少出现3次才算被讲解，降低阈值以捕获更多讲解词）
        *   **示例说明**：
            ```python
            # 单词 "apple" 的出现时间点
            apple_times = [960, 962, 965, 968, 970, 975, 980, 985]
            # 在 [960-1080] 窗口内出现 8 次 → ✅ 保留（被讲解词）
            
            # 单词 "this" 的出现时间点
            this_times = [961, 1100]
            # 任何120秒窗口内最多 1 次 → ❌ 过滤（辅助词）
            ```
    6.  **去重优化**：合并60秒内重复出现的相同单词，仅保留首次出现。
    7.  **时间戳策略**：使用**句子级时间戳**（segment start），确保跳转到完整句子开头，提供更好的上下文。
    8.  **缓存管理**：音频文件保留在 `temp_downloads/` 以便复用（可选择性清理）。
*   **输出**：生成包含 BVID、时间戳和中文上下文的 JSON 索引数据，**只包含真正被讲解的单词**。

### 3.2 索引构建 (Indexing)
*   **映射逻辑**：将 ASR 识别出的单词与 BVID 进行关联。
*   **数据结构优化**：
    *   支持多 P 视频（B站的分集视频）：需记录 `BVID` + `Page_Index (p)`。

### 3.3 前端播放与跳转 (Frontend Playback)
*   **交互逻辑**：
    1.  用户搜索单词，列表展示结果。
    2.  用户点击某一条目。
    3.  对应视频播放位置加载 Bilibili 嵌入式播放器（Iframe）。
    4.  **自动跳转**：播放器 URL 携带时间参数（`&t=xxx`）或通过 JS 控制，直接从目标时间开始播放。
*   **播放器配置**：
    *   需配置 `high_quality=1` (允许的情况下) 以保证清晰度。
    *   需配置 `autoplay=1` (如浏览器策略允许)。

## 4. 数据结构规范 (Data Specification)

### 4.1 视频资源表 (video_map.json)
不再存储本地路径，而是存储 B站的元数据。
```json
{
  "0": {
    "bvid": "BV1Nb411v7XU",
    "p": 1, 
    "title": "TED演讲：如何通过练习学习英语",
    "cover": "http://i0.hdslb.com/bfs/archive/....jpg" // 可选，用于列表展示封面
  },
  "1": {
    "bvid": "BV1Nb411v7XU",
    "p": 2,
    "title": "TED演讲：词汇量拓展训练"
  }
}
```

### 4.2 倒排索引分片 (index_a.json)
结构与 V1.0 类似，但在逻辑上指向在线资源。
```json
{
  "practice": [
    {
      "v": 0,                // 引用 video_map 中的 ID 0
      "t": 125,              // 精确到秒（整数），B站参数通常精确到秒
      "c": "you need to practice everyday" // 上下文
    }
  ]
}
```

## 5. 技术实现路径建议 (Implementation Strategy)

### 5.1 后端处理栈 (Python)
*   **下载工具**: `you-get` (实际采用)。
    *   原因：对 Bilibili 原生支持更好，兼容性强，无需登录即可下载480p/360p视频。
    *   命令示例：`you-get -o output_dir -O filename https://www.bilibili.com/video/BVxxxx`
    *   备注：`yt-dlp` 在测试中遇到连接中断问题，`you-get` 更稳定。
*   **ASR**: 官方 `whisper` (openai-whisper)。
    *   模型：使用 `base` 模型（精度与速度的平衡）。
    *   说明：原计划使用 `stable-whisper` 获取单词级时间戳，但在 macOS CPU 环境下存在兼容性问题（长时间卡死）。改用官方 `whisper` 的 segment 级时间戳，通过算法分配到单词，实际使用中采用**句子级跳转**策略，用户体验更好。
    *   混合语言支持：设置 `initial_prompt="这是一段包含English单词的中文讲解视频。"` 提高中英混合识别准确度。

### 5.2 前端实现栈 (HTML/JS + Bilibili Iframe)
*   **播放器嵌入代码**:
    B站官方 Iframe 格式如下：
    ```html
    <iframe 
      id="biliPlayer"
      src="//player.bilibili.com/player.html?bvid=BV1xx411c7mD&page=1&t=120&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
    ```
*   **动态跳转逻辑 (JavaScript)**:
    由于跨域限制，直接控制 Iframe 内部 `video` 标签比较困难。最稳健的方式是**重新加载 Iframe 的 src**。

    ```javascript
    function playBilibiliVideo(bvid, page, timeInSeconds) {
        const playerFrame = document.getElementById('biliPlayer');
        // 构造 B站 嵌入式 URL
        // t 参数单位为秒
        // page 参数对应分集 (p1 = 1)
        const baseUrl = "//player.bilibili.com/player.html";
        const newSrc = `${baseUrl}?bvid=${bvid}&page=${page}&t=${Math.floor(timeInSeconds)}&high_quality=1&autoplay=1`;
        
        playerFrame.src = newSrc;
    }
    ```

## 6. 关键风险与对策 (Risk & Mitigation)

### 6.1 B站防盗链与跨域策略
*   **风险**：B站有时会限制 Iframe 在非白名单域名的播放，或者强制跳转回 B站 App。
*   **对策**：
    *   在 HTML `<head>` 中添加 Meta 标签：`<meta name="referrer" content="no-referrer">`。这通常能绕过基础的防盗链检查，允许视频在第三方站点加载。

### 6.2 视频失效风险
*   **风险**：UP 主删除了视频或视频被 B站下架，导致索引对应的 BVID 失效。
*   **对策**：
    *   前端处理 `iframe` 加载错误很难（因为跨域），但可以增加“报错/失效反馈”按钮。
    *   定期运行脚本检查 BVID 的 HTTP 状态码（轻量级检查）。

### 6.3 时间轴精度与用户体验
*   **实际策略**：采用**句子级跳转**而非单词级跳转。
    *   当用户点击单词时，视频跳转到包含该单词的**句子开头**。
    *   优势：
        1. 用户能听到完整的句子上下文，理解更自然。
        2. 避免从单词中间突然开始的突兀感。
        3. Whisper 对句子边界的识别非常准确，无需复杂的单词级对齐。
*   **时间偏移处理**：
    *   如果处理的是视频片段（如16:00-20:00），需在保存时加上时间偏移量（如 +960秒），确保跳转到原视频的正确位置。

## 7. 开发环境与依赖
*   **本地开发**：Python 3.8+ (用于跑 Whisper 和下载脚本)。
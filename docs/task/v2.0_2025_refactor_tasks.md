# V2.0 (2025 Update) 任务拆分方案

基于 `prd_v2.0_2025_update.md`，我将本次重构拆解为 **5 个独立的任务**。请按顺序执行，以确保数据的一致性和功能的平滑过渡。

**核心目标：**
1. 解耦文章与试题生成。
2. 引入“文库” (Library) 并实现数据持久化。
3. 实现“一文多测”的动态试题生成。

---

## 任务 1：数据层重构与迁移 (Database Refactoring)

**目标**：更新 IndexedDB 数据模型，新建 `Articles` 表，改造 `History` (QuizRecord) 表，并迁移旧数据。

**核心工作：**
1.  修改 `src/services/db.ts`：
    *   新增 `Article` 接口和表定义。
    *   新增 `QuizRecord` 接口（替代/兼容旧 `History`）。
    *   更新 `SmartReaderDB` 版本，处理 schema 变更。
2.  编写数据迁移脚本：
    *   在应用启动时检查并执行。
    *   将旧 `history` 表数据拆分为 `Article` + `QuizRecord`。

**输入给大模型的内容：**
```markdown
请根据 prd_v2.0_2025_update.md 的 "4. 数据模型变更" 部分，重构数据库层：

1. 修改 `src/services/db.ts`：
   - 增加 `Article` 接口：
     ```typescript
     interface Article {
       id?: number;
       uuid: string; // 使用 uuidv4() 生成
       title: string;
       content: string;
       targetWords: string[];
       difficultyLevel: 'L1' | 'L2' | 'L3';
       createdAt: number;
       source: 'generated' | 'imported';
     }
     ```
   - 增加 `QuizRecord` 接口（原 History 改名或兼容）：
     ```typescript
     interface QuizRecord {
       id?: number;
       articleId: string; // 关联 Article.uuid
       date: number;
       questions: any; // 完整试题快照
       userAnswers: any;
       score: number;
       difficultyFeedback: number;
     }
     ```
   - 升级 `SmartReaderDB` 到 version(2)：
     - 新增 `articles` 表: `++id, uuid, createdAt`
     - 更新 `quizRecords` 表 (原 history): `++id, articleId, date`

2. 创建迁移服务 `src/services/migrationService.ts`：
   - 编写 `migrateV1ToV2()` 函数。
   - 读取旧 `history` 数据。
   - 为每一条记录创建 `Article` (提取 content, title, words)。
   - 创建对应的 `QuizRecord` (关联 articleId)。
   - 保存新数据。

3. 在 `App.tsx` 或 `main.tsx` 中调用迁移逻辑（仅执行一次）。
```

**验收标准：**
- ✅ 数据库成功升级，出现 `articles` 和 `quizRecords` 表。
- ✅ 旧的历史记录成功迁移，不再丢失。
- ✅ 之后的新功能开发将基于新的表结构。

---

## 任务 2：LLM 服务解耦 (LLM Service Decoupling)

**目标**：将原本混合在一起的文章生成和试题生成逻辑拆分为两个独立的方法。

**核心工作：**
1.  修改 `src/services/llmService.ts`（及 mock）。
2.  拆分 `generateArticle` 为 `generateArticleOnly` 和 `generateQuizForArticle`。
3.  调整 Prompt，分别只输出文章 JSON 和 试题 JSON。

**输入给大模型的内容：**
```markdown
请根据 prd_v2.0_2025_update.md 的 "5.1 LLM Service" 部分，重构 LLM 服务：

1. 修改 `src/services/llmService.ts`：
   - 保留原方法（标记为 @deprecated 或移除）。
   - 新增 `generateArticleOnly(words, settings)`：
     - Prompt 仅要求生成 Title, Content (markdown with **bold**), TargetWords。
     - 返回结构：`{ title, content, targetWords }`。
   - 新增 `generateQuizForArticle(articleContent, words, settings)`：
     - Prompt 接收文章全文。
     - 要求生成对应的 Reading Questions (4题) 和 Vocabulary Questions (根据难度配置)。
     - 返回结构：`{ readingQuestions, vocabularyQuestions }`。

2. 同步更新 `src/services/mockLLMService.ts` 以支持开发测试。
```

**验收标准：**
- ✅ `generateArticleOnly` 响应速度更快，且结果纯净（无题目）。
- ✅ `generateQuizForArticle` 能根据给定文本生成题目。
- ✅ Mock 服务能正常工作。

---

## 任务 3：文章生成与文库列表 (Library Core & UI)

**目标**：实现“生成文章”的新流程（生成 -> 入库 -> 阅读），并开发“文库”页面。

**核心工作：**
1.  新建 `src/services/articleService.ts` 用于管理 Articles。
2.  修改首页“生成”按钮逻辑：调用 `generateArticleOnly` -> `articleService.add` -> 跳转阅读页。
3.  新建 `src/pages/LibraryPage.tsx`：展示已生成的文章列表（按特定元数据展示）。
4.  添加导航栏入口。

**输入给大模型的内容：**
```markdown
请根据 prd_v2.0_2025_update.md 的 "功能模块详情 - 模块一" 部分进行开发：

1. Service 层：
   - 创建 `articleService.ts`：实现 `saveArticle`, `getAllArticles`, `deleteArticle`。

2. UI 层 - 首页改造：
   - 点击生成的逻辑改为：先调用 LLM 生成文章，保存到 DB，然后携带 articleId 跳转到 `/read/:articleId`。
   - 不再直接生成题目。

3. UI 层 - 文库页 (`LibraryPage`)：
   - 路径 `/library`。
   - 展示文章卡片列表 (Title, Date, Target Words preview)。
   - 点击卡片跳转 `/read/:articleId`。
   - 提供删除按钮。
   - 在 `App.tsx` 和导航栏添加对应路由和链接。
```

**验收标准：**
- ✅ 首页生成后直接进入阅读页，且此时没有题目。
- ✅ 文库页能看到刚才生成的文章。
- ✅ 点击文库中的文章能进入阅读页。

---

## 任务 4：阅读页改造与测试入口 (Reader Refactor)

**目标**：改造阅读页为“只读模式”，并添加“开始测试”入口。

**核心工作：**
1.  改造 `src/pages/ReadingPage.tsx`：
    - 支持通过 URL 参数 `id` 加载文章。
    - 移除原本“自动显示题目”的逻辑。
    - 底部/悬浮栏新增“Start Quiz”按钮。
2.  新增“历史成绩”面板或 Tab，展示该文章关联的 `QuizRecords`。

**输入给大模型的内容：**
```markdown
请根据 prd_v2.0_2025_update.md 的 "模块一 1.2" 和 "模块二 2.1" 部分改造阅读页：

1. 路由参数支持：
   - 修改 `ReadingPage` 以支持 `/read/:id`。
   - `useEffect` 中通过 `articleService.getById(id)` 加载内容。

2. 界面改造：
   - 默认仅展示文章内容。
   - 添加 "Start Quiz" (开始测试) 按钮 (Fab 或 底部栏)。
   - 添加 "History" (历史记录) 区域，调用 `quizService.getRecordsByArticleId` 展示过往分数。

3. 交互逻辑：
   - 点击 "Start Quiz" -> 触发 Loading 状态 -> 准备进入测试流程 (下一任务实现)。
```

**验收标准：**
- ✅ 阅读页能正确渲染指定 ID 的文章。
- ✅ 界面干净，无题目干扰。
- ✅ “开始测试”按钮可见。
- ✅ 能看到该文章的历史测试分。

---

## 任务 5：动态测试流程实现 (Dynamic Quiz Flow)

**目标**：实现点击“开始测试”后的实时生成、作答与保存流程。

**核心工作：**
1.  在 `ReadingPage` 点击“开始测试”后，调用 `llmService.generateQuizForArticle`。
2.  复用或微调现有的 `QuizView` 组件进行作答。
3.  提交时，保存到 `quizRecords` 表（关联当前 Article ID）。
4.  更新 SRS 单词状态（逻辑保持不变）。

**输入给大模型的内容：**
```markdown
请根据 prd_v2.0_2025_update.md 的 "模块三 测试与结算" 部分实现完整闭环：

1. 测试生成：
   - 点击 "Start Quiz"，读取当前文章内容和单词，调用 `llmService.generateQuizForArticle`。
   - 显示 Loading 遮罩。
   - 生成成功后，弹出 `QuizModal` 或切换到 `QuizView` 模式。

2. 作答与提交：
   - 用户完成作答。
   - 提交时，计算分数。
   - 调用 `quizService.saveQuizRecord({ articleId, ... })` 保存。
   - 触发 SRS 算法更新单词状态。

3. 结算反馈：
   - 显示本次得分。
   - 关闭测试视图，回到阅读页，刷新历史成绩列表。
```

**验收标准：**
- ✅ 点击测试能实时生成新题目。
- ✅ 作答流程顺畅。
- ✅ 成绩被正确保存并关联到该文章。
- ✅ 单词状态得到更新。

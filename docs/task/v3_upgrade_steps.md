# V3.0 升级任务拆分方案

基于 `prd_v3.0.md`，我将 V3.0 的开发过程拆解为 **4 个独立的任务**。这些任务按优先级排序，建议按顺序执行。

**升级原则：**
- 优先完善基础体验（单词本、查词）
- 数据记录与可视化展示分离（先记录，后展示）
- 保持现有功能稳定性

---

## 任务 1：单词本音标显示 (The Phonetics)

**目标**：在单词本列表中显性展示音标，强化“音形义”记忆。

**核心工作：**
- 检查 `Word` 接口定义，确认包含 `phonetic` 字段。
- 修改 `WordCard` 组件（或单词列表项组件），在单词拼写下方或旁边添加音标显示。
- 样式微调：使用灰色或弱化字体，确保不喧宾夺主。

**输入给大模型的内容：**
```markdown
请根据 prd_v3.0.md 中"2.5 UI 设计"部分，优化单词本的显示：

1. 目标组件：`src/components/WordCard.tsx` (或展示单词列表的组件)
2. 需求：
   - 在单词拼写 (spelling) 旁边或下方显示音标 (phonetic)。
   - 样式参考：
     - 字体颜色：灰色 (text.secondary)
     - 字体大小：比单词拼写小一号 (0.9em)
     - 字体家族：'Arial Unicode MS', sans-serif (确保音标显示正常)
   - 如果数据中没有音标，则不显示或显示占位符（视现有数据情况而定）。

请保持卡片原有的交互（点击查看详情、状态颜色标记）不变。
```

**验收标准：**
- ✅ 单词本列表中的单词卡片显示音标。
- ✅ 音标样式美观，层级清晰。
- ✅ 无音标数据的单词显示正常（不崩坏）。

---

## 任务 2：全局单词解释升级 (The Explanation)

**目标**：增强单词详情弹窗，增加朗读、查词典及无视频时的兜底逻辑。这是 V3.0 的核心体验升级。

**核心工作：**
- 修改 `WordDetailModal` 组件。
- 集成 Web Speech API (`window.speechSynthesis`) 实现 TTS。
- 集成 Free Dictionary API 获取详细释义。
- 实现“有视频显示视频，无视频自动查词典”的智能逻辑。

**输入给大模型的内容：**
```markdown
请根据 prd_v3.0.md 中"2.2 交互与UI设计"部分，升级 `WordDetailModal` 组件：

1. 新增功能：
   - **TTS 朗读**：在单词旁添加喇叭图标，点击调用 `window.speechSynthesis.speak()` 朗读单词。
   - **查词典 API**：创建一个 `dictionaryService.ts`，使用 `https://api.dictionaryapi.dev/api/v2/entries/en/<word>` 获取数据。

2. 交互逻辑更新：
   - **状态管理**：新增 `showDictionary` (boolean) 状态。
   - **视频加载失败处理**：
     - 监听 video 标签的 `onError` 事件。
     - 当视频加载失败（即无本地视频）时，自动将 `showDictionary` 设为 true，并调用 API 获取详情。
   - **手动查词**：即使有视频，用户点击新增的“📖 查词典”按钮，也展示词典内容。

3. UI 布局：
   - 头部：单词 + 音标 + 喇叭图标。
   - 内容区：
     - 上部：视频播放器（如果有）。
     - 下部（或替代区）：词典详情（音标、词性、定义、例句）。请设计一个清晰的展示结构。

请确保 API 请求期间有 Loading 状态，请求失败有错误提示。
```

**验收标准：**
- ✅ 点击喇叭图标能听到发音。
- ✅ 点击“查词典”能展示详细释义。
- ✅ 打开不存在视频的单词（如 'abandon'），能自动展示词典内容，而不是仅显示“暂无视频”。

---

## 任务 3：学习时长记录 (The Timer)

**目标**：实现学习时长的自动记录与存储。

**核心工作：**
- 创建 `useStudyTimer` Hook。
- 更新数据库模型 `History`。
- 在阅读页和做题页集成计时逻辑。

**输入给大模型的内容：**
```markdown
请根据 prd_v3.0.md 中"2.7 数据记录逻辑"部分，实现学习时长记录：

1. 数据库更新 (`src/db.ts`)：
   - 修改 `History` 接口，增加 `timeSpent` (number, 单位：秒) 字段。
   - 确保 `saveArticleRecord` 等保存函数支持传入此时长。

2. 计时器 Hook (`src/hooks/useStudyTimer.ts`)：
   - 实现一个 hook，返回 `{ timeSpent, start, pause, reset }`。
   - 使用 `useEffect` 在组件挂载时开始计时，卸载时停止。
   - 监听 `document.visibilitychange`，在页面切后台时暂停计时。

3. 页面集成：
   - 在 `ReadingPage.tsx` 中使用该 hook。
   - 当用户完成阅读并提交做题时，获取最终的 `timeSpent`。
   - 将时长数据连同分数、错题一起保存到数据库。

注意：为了测试方便，可以在控制台打印计时日志。
```

**验收标准：**
- ✅ 完成一次阅读流程后，IndexedDB 的 history 表中新增了 `timeSpent` 字段。
- ✅ 记录的时间数值合理（与实际操作时间接近）。
- ✅ 页面切后台时计时暂停（可选验证）。

---

## 任务 4：统计图表开发 (The Charts)

**目标**：可视化展示学习时长趋势。

**核心工作：**
- 安装 `recharts`。
- 在统计页面增加时长趋势图表。
- 实现数据聚合逻辑。

**输入给大模型的内容：**
```markdown
请根据 prd_v3.0.md 中"2.8 统计图表"部分，在统计页面增加时长趋势图：

1. 依赖安装：
   `npm install recharts`

2. 数据处理：
   - 编写一个辅助函数 `getStudyTimeStats(days=7)`。
   - 从 `history` 表中获取最近 7 天的记录。
   - 按日期聚合（Group By Date），累加每日的 `timeSpent`，转换为分钟。
   - 补全没有记录的日期（填 0）。

3. UI 实现 (`src/pages/StatisticsPage.tsx`)：
   - 新增“学习时长趋势”卡片。
   - 使用 Recharts 的 `<BarChart>` 或 `<AreaChart>` 绘制图表。
   - X轴：日期 (MM-DD)。
   - Y轴：时长 (分钟)。
   - Tooltip：显示具体时长。

请确保图表风格与现有 UI 保持一致（使用主题色）。
```

**验收标准：**
- ✅ 统计页面能看到新的图表。
- ✅ 图表数据准确反映了数据库中的记录。
- ✅ 没有数据的日期显示为 0，而不是缺失。

---

## 给您的操作建议

1.  **任务 2 (全局解释)** 是本次升级最复杂的部分，因为它涉及外部 API 和异步状态管理。建议先让大模型写好 `dictionaryService` 和 Mock 数据，测试通过后再集成到 UI。
2.  **任务 3 (计时器)** 涉及数据库 Schema 变更。如果之前的 `history` 表中已有数据，新字段 `timeSpent` 会是 undefined，请确保前端代码能兼容这种情况（例如显示为 0 或 "未记录"）。
3.  **任务 4 (图表)** 依赖任务 3 的数据。在做任务 4 之前，建议先手动产生几条带有时长的阅读记录，或者让大模型写一个脚本批量更新旧数据（Mock 一些时长）。
